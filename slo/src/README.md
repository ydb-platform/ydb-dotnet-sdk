# SLO workload

SLO is the type of test where app based on ydb-sdk is tested against falling YDB cluster nodes, tablets, network
(that is possible situations for distributed DBs with hundreds of nodes)

### Usage:

It has 3 commands:

- `create`  - creates table in database
- `cleanup` - drops table in database
- `run`     - runs workload (read and write to table with sets RPS)

### Run examples with all arguments:

create:

`slo create grpcs://ydb.cool.example.com:2135 /some/folder -t tableName
--min-partitions-count 6 --max-partitions-count 1000 --partition-size 1 -—Å 1000
--write-timeout 10000`

cleanup:

`slo cleanup grpcs://ydb.cool.example.com:2135 /some/folder -t tableName`

run:

`slo create run grpcs://ydb.cool.example.com:2135 /some/folder -t tableName
--prom-pgw http://prometheus-pushgateway:9091 -report-period 250
--read-rps 1000 --read-timeout 10000
--write-rps 100 --write-timeout 10000
--time 600 --shutdown-time 30`

## Arguments for commands:

### create
`slo create [<endpoint> [<db>]] [options]`

```
Arguments:
  <endpoint>  YDB endpoint to connect to
  <db>        YDB database to connect to

Options:
  -t, --table-name <table-name>                  table name to create
                                                   [default: testingTable]
  --min-partitions-count <min-partitions-count>  minimum amount of partitions in table [default: 6]
  --max-partitions-count <max-partitions-count>  maximum amount of partitions in table [default: 1000]
  --partition-size <partition-size>              partition size in mb [default: 1]
  -c, --initial-data-count <initial-data-count>  amount of initially created rows [default: 1000]
  --write-timeout <write-timeout>                write timeout milliseconds [default: 10000]
```

### cleanup
`slo cleanup [<endpoint> [<db>]] [options]`

```
Arguments:
  <endpoint>  YDB endpoint to connect to
  <db>        YDB database to connect to

Options:
  -t, --table-name <table-name>    table name to create
                                     [default: testingTable]
  --write-timeout <write-timeout>  write timeout milliseconds [default: 10000]
```

### run
`slo run [<endpoint> [<db>]] [options]`

```
Arguments:
  <endpoint>  YDB endpoint to connect to
  <db>        YDB database to connect to

Options:
  -t, --table-name <table-name>                  table name to create
                                                   [default: testingTable]
  --prom-pgw <prom-pgw> (REQUIRED)               minimum amount of partitions in table
  --report-period <report-period>                prometheus push period in milliseconds [default: 250]
  --read-rps <read-rps>                          read RPS [default: 1000]
  --read-timeout <read-timeout>                  read timeout milliseconds [default: 10000]
  --write-rps <write-rps>                        write RPS [default: 100]
  --time <time>                                  run time in seconds [default: 140]
  --shutdown-time <shutdown-time>                time to wait before force kill workers [default: 30]
  -c, --initial-data-count <initial-data-count>  amount of initially created rows [default: 1000]
  --write-timeout <write-timeout>                write timeout milliseconds [default: 10000]
```

## Authentication

Workload using anonymous credentials.

## What's inside
When running `run` command, the program creates two jobs: `readJob` and `writeJob`.

- `readJob`    reads rows from the table one by one with random identifiers generated by writeJob
- `writeJob`   generates and inserts rows

Table have these fields:
- `id Uint64`
- `hash Uint64 Digest::NumericHash(id)`
- `payload_str UTF8`
- `payload_double Double`
- `payload_timestamp Timestamp`
- `payload_hash Uint64`

Primary key: `("hash", "id")`

## Collected metrics
- `oks`      - amount of OK requests
- `not_oks`  - amount of not OK requests
- `inflight` - amount of requests in flight
- `latency`  - summary of latencies in ms
- `attempts` - summary of amount for request

> You must reset metrics to keep them `0` in prometheus and grafana before beginning and after ending of jobs

In `c#` it looks like that:
```c#
private static async Task MetricReset(string promPgwEndpoint, string job)
{
    var deleteUri = $"{promPgwEndpoint}/job/{job}";
    using var httpClient = new HttpClient();
    await httpClient.DeleteAsync(deleteUri);
}
```

## Look at metrics in grafana
You can get dashboard used in that test [here](https://github.com/ydb-platform/slo-tests/blob/main/k8s/helms/grafana.yaml#L69) - you will need to import json into grafana.