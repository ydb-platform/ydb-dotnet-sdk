name: lint
on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  autoformatter:
    strategy:
      matrix:
        source-dir: ["./src/", "./examples/src/"]
        include:
          - source-dir: "./src/"
            solutionFile: "YdbSdk.sln"
          - source-dir: "./examples/src/"
            solutionFile: "YdbExamples.sln"
    name: autoformat check
    concurrency:
      group: lint-autoformat-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'
      - name: Restore
        run: dotnet restore ${{ matrix.source-dir }}${{ matrix.solutionFile }}
      - name: Install ReSharper
        run: dotnet tool install -g JetBrains.ReSharper.GlobalTools --version 2023.2.1
      - name: format all files with auto-formatter
        run: bash ./.github/scripts/format-all-dotnet-code.sh ./src/ ${{ matrix.source-dir }} ${{ matrix.solutionFile }} "Custom Cleanup"
      - name: Check repository diff
        run: bash ./.github/scripts/check-work-copy-equals-to-committed.sh "auto-format broken"

  inspection:
    strategy:
      matrix:
        solutionPath: ["./src/YdbSdk.sln", "./examples/src/YdbExamples.sln"]
    runs-on: ubuntu-latest
    name: Inspection
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'
      - name: Restore
        run: dotnet restore ${{ matrix.solutionPath }}
      - name: Inspect code
        uses: muno92/resharper_inspectcode@v1
        with:
          solutionPath: ${{ matrix.solutionPath }}
          version: 2023.2.1
          include: |
            **.cs
            **.cshtml
          minimumReportSeverity: WARNING
          ignoreIssueType: | 
            UnusedField.Compiler,
            UnusedVariable.Compiler,
            UnusedAutoPropertyAccessor.Global,
            UnusedAnonymousMethodSignature,
            UnusedNullableDirective,
            UnusedTupleComponentInReturnValue,
            UnusedLocalFunction.Compiler,
            UnusedLocalFunctionReturnValue,
            UnusedMethodReturnValue.Global,
            UnusedType.Global,
            UnusedMemberInSuper.Global,
            UnusedMember.Global,
            UnusedMemberHierarchy.Global,
            UnusedLabel,
            UnusedParameter.Global,
            UnusedParameterInPartialMethod,
            UnusedPositionalParameterCompiler,
            UnusedTypeParameter,
            NotAccessedField.Compiler,
            NotAccessedVariable.Compiler,
            NotAccessedField.Global,
            NotAccessedPositionalProperty.Global,
            NotAccessedVariable,
            NotAccessedOutParameterVariable,
            NotAccessedPrimaryConstructorParameterCompiler,
            InconsistentNaming,
            CollectionNeverUpdated.Global
